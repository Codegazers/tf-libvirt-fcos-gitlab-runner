---
variant: fcos
version: 1.0.0
passwd:
  users:
    - name: ${user}
      password_hash: ${password}
      ssh_authorized_keys: 
       - ${ssh_key}
      groups: [ sudo ]
systemd:
  units:
    - name: selinux-dockersock-policy.service
      enabled: true
      contents: |
        [Unit]
        Description=Allow docker container to access the docker socket
        Wants=network-online.target
        After=network-online.target
        ConditionPathExists=!/var/lib/gitlab-runner/config.toml

        [Service]
        Type=oneshot
        WorkingDirectory=/root
        ExecStartPre=curl -L -O https://github.com/ingobecker/tf-libvirt-fcos-gitlab-runner/raw/master/content/dockersock.pp
        ExecStartPre=sh -c 'echo 51e5434a7259d3f578deb8dedb03bc98671d704729da00402ffc73bfc63f079b4af4895d22b477062864d001c53bf2cd18901dba82b6bcdc138685bc27cd4f58 dockersock.pp|sha512sum -c'
        ExecStart=/usr/sbin/semodule -i dockersock.pp
        StandardOutput=journal

        [Install]
        WantedBy=multi-user.target
    - name: gitlab-runner-register.service
      enabled: true
      contents: |
        [Unit]
        Description=Register and start gitlab-runner container
        Wants=network-online.target
        After=network-online.target
        ConditionPathExists=!/var/lib/gitlab-runner/config.toml

        [Service]
        Type=oneshot
        ExecStartPre=mkdir -p /var/lib/gitlab-runner
        ExecStartPre=-/bin/docker pull gitlab/gitlab-runner:latest
        ExecStartPre=-/bin/docker run --rm -v /var/lib/gitlab-runner:/etc/gitlab-runner:Z \
                  gitlab/gitlab-runner:latest register\
                  --non-interactive \
                  --url "https://gitlab.com/" \
                  --registration-token ${gitlab_runner_token} \
                  --executor "docker" \
                  --docker-image "docker:19.03.1" \
                  --docker-privileged \
                  --description "docker-runner(fcos)" \
                  --tag-list "docker,fcos" \
                  --run-untagged="true" \
                  --docker-volumes "/certs/client"
        ExecStart=/bin/docker run -d \
                  --name gitlab-runner \
                  --restart always \
                  --volume /var/lib/gitlab-runner:/etc/gitlab-runner:Z \
                  -v /var/run/docker.sock:/var/run/docker.sock \
                  gitlab/gitlab-runner:latest
        StandardOutput=journal

        [Install]
        WantedBy=multi-user.target
